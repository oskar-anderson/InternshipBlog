<!doctype html><html lang=en><head><link rel=canonical href=https://oskar-anderson.github.io/InternshipBlog/content/graafi-joonistamine/><title>Graafi joonistamine - My Internship Blog</title><link type=text/css href=https://oskar-anderson.github.io/InternshipBlog/css/bootstrap.min.css rel=stylesheet crossorigin=anonymous><link type=text/css href=https://oskar-anderson.github.io/InternshipBlog/css/main-layout.css rel=stylesheet crossorigin=anonymous><link rel=icon type=image/png href=https://oskar-anderson.github.io/InternshipBlog/favicon.png crossorigin=anonymous></head><body><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://oskar-anderson.github.io/InternshipBlog/>Home</a></h1></div></div></header><header class=post-header><h1 class=post-title itemprop="name headline">Graafi joonistamine</h1></header><div class=container><div class=row><div class="col-sm-9 blog-main"><article class=blog-post><header><h2 class=blog-post-title dir=auto><a href=https://oskar-anderson.github.io/InternshipBlog/content/graafi-joonistamine/>Graafi joonistamine</a></h2><p class=blog-post-meta><time datetime=2021-05-25>2021-05-25</time>
Karl Oskar Anderson
<span class="fas fa-tag" aria-hidden=true></span>&nbsp;<a href=/InternshipBlog/tags/praktika/ rel=tag>praktika</a> <a href=/InternshipBlog/tags/riina-tallo/ rel=tag>Riina Tallo</a></p></header><h2 id=12-nädal>12. nädal</h2><h3 id=1705>17.05</h3><p>Alustasin graafi joonistamise programmeerimist. PHP paneb sensori mõõtmiste andmed div elemendi data atribuuti JSON&rsquo;ina sisse, JS parsib need välja ja käsitleb neid sõltuvalt kasutaja valikutele.</p><p>Sensorite värvide joaks kasutasin seeded randomness funktsiooni:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PHP data-lang=PHP>$colorsHardCoded <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;#7F0AAC&#39;</span>, <span style=color:#e6db74>&#39;#178152&#39;</span>, <span style=color:#e6db74>&#39;#D4D335&#39;</span>, <span style=color:#e6db74>&#39;#ED9800&#39;</span>, <span style=color:#e6db74>&#39;#F91F2E&#39;</span>];
$colors <span style=color:#f92672>=</span> [];
<span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>sizeof</span>($sensors) <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>; $i<span style=color:#f92672>++</span>) {
    <span style=color:#66d9ef>if</span> ($i <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>sizeof</span>($colorsHardCoded)) {
        <span style=color:#a6e22e>mt_srand</span>($i <span style=color:#f92672>*</span> <span style=color:#ae81ff>13</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
        $val <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;#&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>str_pad</span>(<span style=color:#a6e22e>dechex</span>(<span style=color:#a6e22e>mt_rand</span>(<span style=color:#ae81ff>0x000000</span>, <span style=color:#ae81ff>0xFFFFFF</span>)), <span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#39;0&#39;</span>, <span style=color:#a6e22e>STR_PAD_RIGHT</span>);
        <span style=color:#a6e22e>array_push</span>($colors, $val);
    } <span style=color:#66d9ef>else</span> {
        <span style=color:#a6e22e>array_push</span>($colors, $colorsHardCoded[$i]);
    }
}
</code></pre></div><h3 id=1805>18.05</h3><p>Sensori andmete kuvamiseks tuleb koostada diskreetsed vahemikud kuhu sensorite mõõmise tulemused sisse filtreeritakse.</p><p>Vahemike saamiseks kasutasin MomentJS teeki kuna JS sisseehitatud funktsionaalsus annab soovida. Tegemist on kõige populaarseme JS aja teegiga, imelikul kombel soovitatakse teegi kodulehel mingit alternatiivset teeki kasutada.</p><p>Diskreetsete vahemike tekitamisega ilmneb väike probleem MomentJS teegiga - selle objektid on muutuvad:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dataFromPHP</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElement</span>(<span style=color:#e6db74>&#39;data&#39;</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dateFrom</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>moment</span>(<span style=color:#a6e22e>dataFromPHP</span>.<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#39;data-datafrom&#39;</span>, <span style=color:#e6db74>&#39;DD-MM-YYYY, HH:mm&#39;</span>))
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dateTo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>moment</span>(<span style=color:#a6e22e>dataFromPHP</span>.<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#39;data-dataTo&#39;</span>), <span style=color:#e6db74>&#39;DD-MM-YYYY, HH:mm&#39;</span>)
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>step</span> <span style=color:#f92672>=</span> parseInt(document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;graphOptionsIntervalSelect&#39;</span>).<span style=color:#a6e22e>value</span>)

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>xAxisTimes</span> <span style=color:#f92672>=</span> [];
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>nextDate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dateFrom</span>.<span style=color:#a6e22e>clone</span>();
<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>nextDate</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>dateTo</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>){
    <span style=color:#75715e>// clone() might look horrible but it is the only way since momentJS object is mutable
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>nextDate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dateFrom</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>step</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>i</span>, <span style=color:#e6db74>&#39;minutes&#39;</span>);  
    <span style=color:#a6e22e>xAxisTimes</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>nextDate</span>);
}
</code></pre></div><h3 id=1905>19.05</h3><p>Filtreeritud väärtused sain lihtsalt:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sensorReadings</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>x</span> =&gt; <span style=color:#a6e22e>before</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>date</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>after</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>date</span>);
</code></pre></div><p>Selline lähenemine on aeglane, kuna see ei arvesta sellega, et <code>sensorReadings</code> array on juba <code>date</code> välja suhtes sorteeritud. Parem lähenemine oleks:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>FilterSortedArrayValuesBetweenDates</span>(<span style=color:#a6e22e>sensorReadings</span>, <span style=color:#a6e22e>before</span>, <span style=color:#a6e22e>after</span>, <span style=color:#a6e22e>low</span>) {
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> [];
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>low</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>sensorReadings</span>.<span style=color:#a6e22e>lenght</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
        <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sensorReadings</span>[<span style=color:#a6e22e>low</span>];
        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>after</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>date</span>) { <span style=color:#66d9ef>break</span>; }
        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>before</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>date</span>) { <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>obj</span>); }
        <span style=color:#a6e22e>low</span><span style=color:#f92672>++</span>;
    }
    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#39;result&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>result</span>,
        <span style=color:#e6db74>&#39;low&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>low</span>
    };
}
</code></pre></div><p>Andmete lugemine toimus aeglaselt. Vahetasin MomentJS teegi dayjs teegi vastu välja. Kuupäevade sõnede objektiks muumine läks poole kiiremaks. MomentJS muutis 8000 sõne kuupäeva objektiks umbes 150ms - DayJS 75ms.</p><h3 id=2005>20.05</h3><p>Proovisin graafiku skaala väärtused käsitsi sisse anda. Algselt oli plaan kuvada temperatuuri ja niiskuse andmed samal teljel. See tundub olevat võimalik, aga kahjuks nõuab see liiga palju andmete töötlemist, et seda õigustada.</p><p>Samuti proovisin suurendada astet horisontaalsel teljel (kuupäevad) - kuupäevad on liiga tihedalt. Kahjuks ei tulnud see üldse välja. Huvitav, et Y-teljel tundus see võimalik olevat.</p><p>Graafiku joonistamine on valmis.</p><p>Käisin kontoris. Aivar oli dokumentatsiooni valmis saanud. Näitasin oma tööd Annely-le ja küsisin tagasisidet:</p><ul><li>Eksporditud CSV andmetele pealkirjad esimesele reale. Muidu pead ise aru saama tulbas olevatest andmetest ja nende ühikutest.</li><li>Võimalus andmeid lihtsamini eksportida, et neid kiiresti e-kirjadesse panna. Vajadusel saab graafikut manuaalselt screenshotida, aga see funktsionaalsus peaks olema sissekirjutatud.</li><li>Võimalus portatiivse sensori andmeid üles laadida.</li></ul><p>Tuleb välja, et portatiivsete sensorite anded on kõige tähtsamad. See tuli üllatusena, sest portatiivseid sensoreid on hetkel ainult üks. Seda kasutatakse hetkel pigem tagavara ja statsionaarsete sensorite kontrolli eesmärgil. Samuti olin ma arusaamisel, et transpordi autodes on temperatuurisüsteem olemas, aga selgus, et see on funktsionaalsus on piiratud.</p><h3 id=2105>21.05</h3><p>Tegin graafi pildi eksporti võimaluse.</p><p>Kõigepealt lisasin graafikule legendi. Leheküljel ei ole legendi vaja, sest andmete tähendus vastab kasutaja seadistustele, aga pilt on ainult graafikust endast.</p><p>Pilti on võimalik saada läbi kahe teegi html2canvas ja FileSaver. Kõigepealt joonistatakse DOM element canvas elemendiks, sellest koostatakse data URI (pildi andmete hoidmise viis), ja saadud pilt laetakse alla.</p><p>Kahjuks töötab see lahendus liiga aeglaselt ja ebakindlalt. Graafiku element on Google Charts teegi poolt koostatud. See koosneb paljudest erinevatest div ja svg elementidest, mis on kaootiliselt üksteise sisse topitud. Ilmselt võtab kõigi nende elementide töötamine kaua aega.</p><p>Õnneks ei pea ratast leiutama. Google Chart lubab väga lihtalt graafi pildina kujutada:
<a href=https://developers.google.com/chart/interactive/docs/printing>https://developers.google.com/chart/interactive/docs/printing</a>
Pilt tuleb panna nähtamatu elemendi sisse. Edasi tuleb lisada nupp, mis pärib funktsiooni, mis kasutab nähtamatu elemendi andmeid ja ekspordib nad samamoodi nagu CSV andmed kasutajale välja.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>div</span>&gt;
    &lt;<span style=color:#f92672>p</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chartErr&#34;</span>&gt;&lt;/<span style=color:#f92672>p</span>&gt;
    &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chartDiv&#34;</span>&gt;
        &lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SaveImg&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span>&gt;&lt;/<span style=color:#f92672>button</span>&gt;
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chart&#34;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chartAsPictureDiv&#34;</span>&gt;&lt;/<span style=color:#f92672>div</span>&gt;
    &lt;/<span style=color:#f92672>div</span>&gt;
&lt;/<span style=color:#f92672>div</span>&gt;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;saveImg&#39;</span>).<span style=color:#a6e22e>onclick</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>SaveChartImg</span>;

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>drawChart</span>() {
    <span style=color:#75715e>// lots of code for data and options ...
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>chart</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>google</span>.<span style=color:#a6e22e>visualization</span>.<span style=color:#a6e22e>LineChart</span>(<span style=color:#a6e22e>chartEle</span>);

    <span style=color:#a6e22e>google</span>.<span style=color:#a6e22e>visualization</span>.<span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>addListener</span>(<span style=color:#a6e22e>chart</span>, <span style=color:#e6db74>&#39;ready&#39;</span>, <span style=color:#66d9ef>function</span> () {
        document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;chartAsPictureDiv&#39;</span>).<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;img id=&#34;chartAsPictureImg&#34; src=&#34;&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>chart</span>.<span style=color:#a6e22e>getImageURI</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;&#34;&gt;&#39;</span>;
    });

    <span style=color:#a6e22e>chart</span>.<span style=color:#a6e22e>draw</span>(<span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>options</span>);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>SaveChartImg</span>() {
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>base64</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;chartAsPictureImg&#39;</span>).<span style=color:#a6e22e>src</span>;
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dateFrom</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;data&#39;</span>).<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#39;data-dataFrom&#39;</span>);
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dateTo</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;data&#39;</span>).<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#39;data-dataTo&#39;</span>);
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>filename</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;tempsens &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>dateFrom</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;-&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>dateTo</span>;
    <span style=color:#a6e22e>ExportBase</span>(<span style=color:#a6e22e>base64</span>, <span style=color:#a6e22e>filename</span>);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ExportBase</span>(<span style=color:#a6e22e>encodedUri</span>, <span style=color:#a6e22e>filename</span>) {
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>link</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>creteElement</span>(<span style=color:#e6db74>&#39;a&#39;</span>);
    document.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>link</span>); <span style=color:#75715e>// for FF
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>setAttribute</span>(<span style=color:#e6db74>&#39;href&#39;</span>, <span style=color:#a6e22e>encodedUri</span>);
    <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>setAttribute</span>(<span style=color:#e6db74>&#39;download&#39;</span>, <span style=color:#a6e22e>filename</span>);
    <span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>click</span>();
}
</code></pre></div><div class=comments><hr><h2>Comments</h2><span style=display:none><ul><li>issue-term=Graafi joonistamine</li><li>issue-term=2021-05-25_#1</li></ul></span><script src=https://utteranc.es/client.js repo=oskar-anderson/InternshipBlog issue-term=2021-05-25_#1 label=utterance-comment theme=github-light crossorigin=anonymous async></script></div></article></div><aside class="col-sm-3 ml-auto blog-sidebar"><h2 style=font-size:125%;text-transform:uppercase>Latest</h2><div><ul class=post-list style=list-style:square;padding-left:17px><li><a href=https://oskar-anderson.github.io/InternshipBlog/content/l%C3%B5pusirge/ itemprop=url>Lõpusirge</a></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/content/arendamine/ itemprop=url>Arendamine</a></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/content/graafi-joonistamine/ itemprop=url>Graafi joonistamine</a></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/content/lehe-arendamine/ itemprop=url>Lehe arendamine</a></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/content/AB-muutmine-ja%20vana%20koodi%20kohandamine/ itemprop=url>AB muutmine ja vana koodi kohandamine</a></li></ul></div><h2 style=font-size:125%;text-transform:uppercase>Tags</h2><div><ul class=post-list style=list-style:square;padding-left:17px><li><a href=https://oskar-anderson.github.io/InternshipBlog/tags/m%C3%A4rkmed/>märkmed</a>
<span style=color:grey;font-size:80%>(1)</span></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/tags/praktika/>praktika</a>
<span style=color:grey;font-size:80%>(9)</span></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/tags/riina-tallo/>Riina Tallo</a>
<span style=color:grey;font-size:80%>(10)</span></li><li><a href=https://oskar-anderson.github.io/InternshipBlog/tags/test/>test</a>
<span style=color:grey;font-size:80%>(1)</span></li></ul></div></aside></div></div><hr><footer style=margin-bottom:20px><div class=container><a href=#></a><div class=site-title-wrapper><h1 class=site-title><a href=https://oskar-anderson.github.io/InternshipBlog/>Home</a></h1></div></div></footer></body></html>